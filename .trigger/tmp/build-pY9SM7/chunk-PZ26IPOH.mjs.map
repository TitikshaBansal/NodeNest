{
  "version": 3,
  "sources": ["../../../src/trigger/tasks/cropImage.ts"],
  "sourcesContent": ["import { task } from \"@trigger.dev/sdk\";\r\nimport { exec } from \"child_process\";\r\nimport { promisify } from \"util\";\r\nimport * as fs from \"fs/promises\";\r\nimport * as path from \"path\";\r\nimport * as os from \"os\";\r\nimport { Transloadit } from \"transloadit\";\r\n\r\nconst execAsync = promisify(exec);\r\n\r\n// Helper to poll assembly status until complete\r\nasync function waitForAssembly(statusUrl: string, maxAttempts = 60): Promise<any> {\r\n  for (let attempt = 0; attempt < maxAttempts; attempt++) {\r\n    const response = await fetch(statusUrl);\r\n    const status = await response.json();\r\n\r\n    if (status.ok === \"ASSEMBLY_COMPLETED\") {\r\n      return status;\r\n    }\r\n\r\n    if (status.ok === \"ASSEMBLY_CANCELED\" || status.ok === \"ASSEMBLY_FAILED\") {\r\n      throw new Error(`Assembly failed: ${status.error || status.message}`);\r\n    }\r\n\r\n    await new Promise(resolve => setTimeout(resolve, 2000));\r\n  }\r\n\r\n  throw new Error(\"Assembly timed out\");\r\n}\r\n\r\ninterface CropPayload {\r\n  nodeId: string;\r\n  workflowRunId: string;\r\n  inputs: {\r\n    imageUrl: string;\r\n    x?: number;\r\n    y?: number;\r\n    width?: number;\r\n    height?: number;\r\n    xPercent?: number;\r\n    yPercent?: number;\r\n    widthPercent?: number;\r\n    heightPercent?: number;\r\n  };\r\n}\r\n\r\nexport const cropImage = task({\r\n  id: \"crop-image\",\r\n  retry: {\r\n    maxAttempts: 2,\r\n  },\r\n\r\n  run: async (payload: CropPayload) => {\r\n    const { nodeId, workflowRunId, inputs } = payload;\r\n\r\n    const {\r\n      imageUrl,\r\n      x,\r\n      y,\r\n      width,\r\n      height,\r\n      xPercent,\r\n      yPercent,\r\n      widthPercent,\r\n      heightPercent,\r\n    } = inputs;\r\n\r\n    const startTime = Date.now();\r\n    let tempDir: string | null = null;\r\n\r\n    try {\r\n      const transloadit = new Transloadit({\r\n        authKey: process.env.TRANSLOADIT_AUTH_KEY!,\r\n        authSecret: process.env.TRANSLOADIT_AUTH_SECRET!,\r\n      });\r\n\r\n      // Create temp directory\r\n      tempDir = await fs.mkdtemp(path.join(os.tmpdir(), \"crop-\"));\r\n      const tempInputPath = path.join(tempDir, \"input.jpg\");\r\n      const tempOutputPath = path.join(tempDir, \"output.jpg\");\r\n\r\n      // Download image\r\n      const imageResponse = await fetch(imageUrl);\r\n      const imageBuffer = await imageResponse.arrayBuffer();\r\n      await fs.writeFile(tempInputPath, Buffer.from(imageBuffer));\r\n\r\n      // Get dimensions\r\n      const probeCommand = `ffprobe -v error -select_streams v:0 -show_entries stream=width,height -of json \"${tempInputPath}\"`;\r\n      const probeOutput = await execAsync(probeCommand);\r\n      const probeData = JSON.parse(probeOutput.stdout);\r\n\r\n      const imgWidth = probeData.streams[0].width;\r\n      const imgHeight = probeData.streams[0].height;\r\n\r\n      // Calculate crop values\r\n      let cropX: number, cropY: number, cropWidth: number, cropHeight: number;\r\n\r\n      if (\r\n        xPercent !== undefined ||\r\n        yPercent !== undefined ||\r\n        widthPercent !== undefined ||\r\n        heightPercent !== undefined\r\n      ) {\r\n        cropX = Math.round(((xPercent ?? 0) / 100) * imgWidth);\r\n        cropY = Math.round(((yPercent ?? 0) / 100) * imgHeight);\r\n        cropWidth = Math.round(((widthPercent ?? 100) / 100) * imgWidth);\r\n        cropHeight = Math.round(((heightPercent ?? 100) / 100) * imgHeight);\r\n      } else {\r\n        cropX = x ?? 0;\r\n        cropY = y ?? 0;\r\n        cropWidth = width ?? imgWidth;\r\n        cropHeight = height ?? imgHeight;\r\n      }\r\n\r\n      // Crop via FFmpeg\r\n      const ffmpegCommand = `ffmpeg -i \"${tempInputPath}\" -filter:v \"crop=${cropWidth}:${cropHeight}:${cropX}:${cropY}\" \"${tempOutputPath}\" -y`;\r\n      await execAsync(ffmpegCommand);\r\n\r\n      // Upload cropped image\r\n      const assembly = await transloadit.createAssembly({\r\n        files: {\r\n          image: tempOutputPath,\r\n        },\r\n        params: {\r\n          steps: {\r\n            \":original\": {\r\n              robot: \"/upload/handle\",\r\n            },\r\n          },\r\n        },\r\n      });\r\n\r\n      // Wait for upload to complete\r\n      const uploadResult = await waitForAssembly(assembly.status_endpoint as string);\r\n\r\n      // Get URL\r\n      let outputUrl: string | null = null;\r\n\r\n      if (uploadResult.results?.[\":original\"]?.[0]?.ssl_url) {\r\n        outputUrl = uploadResult.results[\":original\"][0].ssl_url;\r\n      } else if (uploadResult.results?.[\":original\"]?.[0]?.url) {\r\n        outputUrl = uploadResult.results[\":original\"][0].url;\r\n      } else if (uploadResult.uploads?.[0]?.ssl_url) {\r\n        outputUrl = uploadResult.uploads[0].ssl_url;\r\n      } else if (uploadResult.uploads?.[0]?.url) {\r\n        outputUrl = uploadResult.uploads[0].url;\r\n      }\r\n\r\n      if (!outputUrl) {\r\n        throw new Error(\"Transloadit upload failed - no URL found.\");\r\n      }\r\n\r\n      const duration = Date.now() - startTime;\r\n\r\n      return {\r\n        success: true,\r\n        output: outputUrl,\r\n        duration,\r\n        nodeId,\r\n        workflowRunId,\r\n      };\r\n    } catch (error: any) {\r\n      const duration = Date.now() - startTime;\r\n\r\n      return {\r\n        success: false,\r\n        error: error.message || \"Failed to crop image\",\r\n        duration,\r\n        nodeId,\r\n        workflowRunId,\r\n      };\r\n    } finally {\r\n      // Cleanup temp directory safely\r\n      if (tempDir) {\r\n        try {\r\n          await fs.rm(tempDir, { recursive: true, force: true });\r\n        } catch {}\r\n      }\r\n    }\r\n  },\r\n});"],
  "mappings": "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",
  "names": []
}
